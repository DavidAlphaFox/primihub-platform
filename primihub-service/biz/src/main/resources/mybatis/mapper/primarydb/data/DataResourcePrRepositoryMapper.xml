<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yyds.biz.repository.primarydb.data.DataResourcePrRepository">
    <insert id="saveResource" keyProperty="resourceId" useGeneratedKeys="true"
            parameterType="com.yyds.biz.entity.data.po.DataResource">
        insert into data_resource (resource_name,resource_desc,resource_sort_type,resource_auth_type,resource_source,
                    resource_num,file_id,file_size,file_suffix,file_columns,file_rows,file_handle_field,file_handle_status,db_id,user_id,organ_id,url,create_date,update_date)
        values (#{resourceName},#{resourceDesc},#{resourceSortType},#{resourceAuthType},#{resourceSource},#{resourceNum},#{fileId},
                #{fileSize},#{fileSuffix},#{fileColumns},#{fileRows},#{fileHandleField},#{fileHandleStatus},#{dbId},#{userId},#{organId},#{url},now(),now())
    </insert>

    <insert id="saveResourceTagRelation">
        insert into data_rt (resource_id,tag_id,create_date,update_date)
        values (#{resourceId},#{tagId},now(),now())
    </insert>

    <insert id="saveResourceTag" keyProperty="tagId" useGeneratedKeys="true"
            parameterType="com.yyds.biz.entity.data.po.DataResourceTag">
        insert into data_resource_tag (tag_name,create_date,update_date)
        values (#{tagName},now(),now())
    </insert>

    <insert id="saveResourceAuthRecordList" parameterType="com.yyds.biz.entity.data.po.DataResourceAuthRecord">
        insert into data_resource_auth_record (record_status,user_id,user_name,project_id,resource_id,create_date,update_date)
        values
        <foreach collection="list" index="index" item="item" separator=",">
            (#{item.recordStatus},#{item.userId},#{item.userName},#{item.projectId},#{item.resourceId},now(),now())
        </foreach>
    </insert>

    <insert id="saveResourceAuthRecord" parameterType="com.yyds.biz.entity.data.po.DataResourceAuthRecord">
        insert into data_resource_auth_record (record_status,user_id,user_name,project_id,resource_id,create_date,update_date)
        values (#{recordStatus},#{userId},#{userName},#{projectId},#{resourceId},now(),now())
    </insert>
    <insert id="saveResourceFileFieldBatch">
        insert into data_file_field (file_id,resource_id,field_name,field_as,field_type,field_desc,`relevance`,`grouping`,protection_status,is_del,create_date,update_date)
        values
        <foreach collection="list" index="index" item="item" separator=",">
            (#{item.fileId},#{item.resourceId},#{item.fieldName},#{item.fieldAs},#{item.fieldType},#{item.fieldDesc},#{item.relevance},#{item.grouping},#{item.protectionStatus},0,now(),now())
        </foreach>
    </insert>

    <update id="editResource" parameterType="com.yyds.biz.entity.data.po.DataResource">
        update data_resource
        <set>
            <if test="resourceName!=null">
                resource_name = #{resourceName},
            </if>
            <if test="resourceDesc!=null">
                resource_desc = #{resourceDesc},
            </if>
            <if test="resourceSortType!=null">
                resource_sort_type = #{resourceSortType},
            </if>
            <if test="resourceAuthType!=null">
                resource_auth_type = #{resourceAuthType},
            </if>
            <if test="resourceSource!=null">
                resource_source = #{resourceSource},
            </if>
            <if test="resourceNum!=null">
                resource_num = #{resourceNum},
            </if>
            <if test="fileId!=null"> file_id = #{fileId},</if>
            <if test="fileSize!=null">file_size = #{fileSize},</if>
            <if test="fileSuffix!=null"> file_suffix = #{fileSuffix},</if>
            <if test="fileColumns!=null">file_columns = #{fileColumns},</if>
            <if test="fileRows!=null"> file_rows = #{fileRows},</if>
            <if test="fileHandleField!=null">file_handle_field = #{fileHandleField},</if>
            <if test="fileHandleStatus!=null">file_handle_status = #{fileHandleStatus},</if>
            <if test="dbId!=null">db_id = #{dbId},</if>
            <if test="userId!=null">user_id = #{userId},</if>
            <if test="organId!=null">organ_id = #{organId},</if>
            <if test="url!=null">url=#{url},</if>
            update_date = now()
        </set>
        where resource_id = #{resourceId}
    </update>
    <update id="updateAuthRecordStatus">
        update data_resource_auth_record
        set
            record_status = #{status},
            user_id = #{userId},
            user_name = #{userName},
            update_date = now()
        where record_id = #{recordId}
    </update>
    <update id="updateResourceFileField" parameterType="com.yyds.biz.entity.data.po.DataFileField">
        update data_file_field
        <set>
            <if test="fieldName!=null">field_name = #{fieldName},</if>
            <if test="fieldAs!=null">field_as = #{fieldAs},</if>
            <if test="fieldType!=null">field_type = #{fieldType},</if>
            <if test="fieldDesc!=null">field_desc = #{fieldDesc},</if>
            <if test="relevance!=null">`relevance` = #{relevance},</if>
            <if test="grouping!=null">`grouping` = #{grouping},</if>
            <if test="protectionStatus!=null">protection_status = #{protectionStatus},</if>
            update_date = now()
        </set>
        where field_id = #{fieldId}
    </update>

    <delete id="deleteRelationResourceTag">
        delete from data_rt where resource_id = #{resourceId} and tag_id in
        <foreach collection="tags" index="index" item="item" open="("
                 separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <delete id="deleteResource">
        delete from data_resource where resource_id = #{resourceId}
    </delete>

    <delete id="deleteResourceTag">
        delete from data_resource_tag where tag_id in
        <foreach collection="tags" index="index" item="item" open="("
                 separator="," close=")">
            #{item}
        </foreach>
    </delete>
</mapper>